{% extends 'base.html.twig' %}

{% block title %}Partition{% endblock %}

{% block body %}
    <div class="container py-4">
        <h1 class="mb-4">Partition</h1>

        <div class="row gx-4 align-items-stretch"> {# gx-4 = écart horizontal entre colonnes #}
            <div class="col-md-6 d-flex flex-column">
                <label for="message" class="form-label">Édition</label>
                <textarea class="form-control flex-grow-1" id="message" rows="25" placeholder="Écrivez ici..." style="font-family: monospace;"></textarea>
            </div>

            <div class="col-md-6 d-flex flex-column">
                <label class="form-label">Rendu</label>
                <div id="rendered" class="form-control flex-grow-1" style="height: 100%; font-family: monospace; white-space: pre-wrap; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    {% block script %}
        <style>
            .chord {
                color: blue;
                font-weight: bold;
            }
        </style>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const input = document.getElementById('message');
                const output = document.getElementById('rendered');

                function renderChordPro(text) {
                    const lines = text.split('\n');
                    let inChorus = false;

                    const renderedLines = lines.map(line => {
                        const trimmed = line.trim();

                        // Gestion des directives simples
                        if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                            const directive = trimmed.slice(1, -1).trim();

                            if (directive.startsWith('title:')) {
                                const title = directive.slice(6).trim();
                                return title.split(' ')
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                    .join(' ');
                            } else if (directive.startsWith('subtitle:')) {
                                return directive.slice(9).trim(); // Sous-titre
                            } else if (directive === 'start_of_chorus') {
                                inChorus = true;
                                return 'Refrain';
                            } else if (directive === 'end_of_chorus') {
                                inChorus = false;
                                return '';
                            } else {
                                return ''; // Ignorer les autres directives
                            }
                        }


                        let chordLine = '';
                        let lyricLine = '';
                        let i = 0;

                        while (i < line.length) {
                            if (line[i] === '[') {
                                const end = line.indexOf(']', i);
                                if (end !== -1) {
                                    const chord = line.slice(i + 1, end);
                                    const chordPos = lyricLine.length;
                                    while (chordLine.length < chordPos) {
                                        chordLine += ' ';
                                    }
                                    chordLine += chord;
                                    i = end + 1;
                                } else {
                                    lyricLine += line[i];
                                    i++;
                                }
                            } else {
                                lyricLine += line[i];
                                if (chordLine.length < lyricLine.length) {
                                    chordLine += ' ';
                                }
                                i++;
                            }
                        }

                        const combined = chordLine + '\n' + lyricLine;
                        return combined;
                    });

                    return renderedLines.join('\n\n');
                }

                input.addEventListener('input', () => {
                    output.innerText = renderChordPro(input.value);
                });
            });
        </script>
    {% endblock %}
{% endblock %}
